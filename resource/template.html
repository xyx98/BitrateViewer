<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
  <meta charset="utf-8">
</head>
<body style="height: 100%; margin: 0">
  <div id="container" style="height: 100%"></div>
  
  <script type="text/javascript" src="https://registry.npmmirror.com/echarts/5.6.0/files/dist/echarts.min.js"></script>

  <script type="text/javascript">
    var dom = document.getElementById('container');
    var myChart = echarts.init(dom, null, {
      renderer: 'canvas',
      useDirtyRect: false
    });
    var app = {};
    
    var option;

const data = generateData();
option = {
  title: {
    text: data.name,
    left: 10
  },
  color: ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc'],
  toolbox: {
    feature: {
      restore: {
        show: true
      },
      saveAsImage: {
        pixelRatio: 2,
        show: false
      }
    }
  },
  tooltip: {
    trigger: 'axis',
    confine:true,
    extraCssText: 'max-width:400px; white-space: pre-wrap;word-break: break-all;word-wrap: break-word;',
    axisPointer: {
      type: 'line',
      label:{
      show:true,
      snap: true,
      formatter: function (params){
        return `frame: ${params.value}|${pts2time(data.pts[params.value])}|${data.pict_type[params.value]}`
        }
      }
    },
    valueFormatter: (value) => `${value} kbps`
  },
  grid: {
    bottom: 90
  },
  dataZoom: [
    {
      type: 'inside'
    },
    {
      type: 'slider'
    }
  ],
  xAxis: {
    data: data.x,
    silent: false,
    splitLine: {
      show: false
    },
    splitArea: {
      show: false
    },
    axisLabel: {
      formatter: function(value,index){
        return `${pts2time(data.pts[value])}`
      }
    }
  },
  yAxis: {
    splitArea: {
      show: false
    },
    axisLabel: {
      formatter: '{value} kbps'
    }
  },
  series: [
    {
      type: 'bar',
      data: data.y,
      //sampling:'lttb', //if enable sampling,markline avg has wrong value
      large: false,
      symbol:['none','none'],
      barCategoryGap:"0%",
      markLine: {
        symbol: ['none','none'],
        data: [
          { 
            //yAxis: data.avg, //use static markline
            precision: 3,
            silent: true,
            type: 'average',
            name: 'avg' ,
            label:{
              formatter:"avg {c}kbps"
            }
          }
        ]
      },
      itemStyle: {
        color:function(params){
          ft=data.pict_type[params.dataIndex];
          if (ft=="B") return option.color[0];
          else if (ft=="P") return option.color[1];
          else if (ft=="I") return option.color[3];
          else return option.color[6];
        },
      }
    }
  ]
};
function generateData() {
  {{{datas}}}
  return {
    x: x,
    y: y,
    pts: pts,
    pict_type:pict_type,
    avg:avg,
    name:name
  };
}

function pts2time(pts){
  h=0;
  m=0;
  s=Math.floor(pts/1000);
  ms=pts%1000;
  if (s>=60){
    m=Math.floor(s/60);
    s=s%60;
    if (m>=60){
      h=Math.floor(m/60);
      m=m%60;
    };
  };
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}.${String(ms).padEnd(3, '0')}`;
}

    if (option && typeof option === 'object') {
      myChart.setOption(option);
    }

    window.addEventListener('resize', myChart.resize);
  </script>
</body>
</html>
